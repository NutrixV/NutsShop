# Тестування NutsShop

Цей каталог містить тести для NutsShop. Тести розділені на дві категорії:

- Unit тести - для тестування окремих компонентів (моделей та сервісів)
- Feature тести - для тестування API ендпоінтів

## Структура тестів

```
tests/
├── Feature/
│   └── Api/
│       ├── CatalogCategoryTest.php
│       ├── CatalogProductTest.php
│       ├── CatalogTest.php
│       ├── CartTest.php
│       ├── CustomerTest.php
│       └── OrderTest.php
├── Unit/
│   ├── Models/
│   │   ├── CatalogProductTest.php
│   │   ├── CustomerEntityTest.php
│   │   ├── QuoteTest.php
│   │   └── SalesOrderTest.php
│   └── README.md
└── README.md
```

## Запуск тестів

Для запуску всіх тестів:

```bash
docker compose exec php php artisan test
```

Для запуску тільки юніт-тестів:

```bash
docker compose exec php php artisan test --testsuite=Unit
```

Для запуску тільки feature-тестів:

```bash
docker compose exec php php artisan test --testsuite=Feature
```

Для запуску окремого файлу з тестами:

```bash
docker compose exec php php artisan test --filter=CustomerTest
```

## Поточний стан

### Unit-тести

- ✅ Базові тести моделей
  - CustomerEntity
  - CatalogProduct
  - Quote
  - SalesOrder

### API-тести

- ✅ Customer API
  - Реєстрація
  - Логін
  - Отримання профілю
  - Оновлення профілю
  - Логаут (симуляція)
- ✅ Catalog API
  - Отримання категорій
  - Отримання продуктів
  - Фільтрація продуктів
- ✅ Cart API
  - Створення кошика
  - Отримання кошика
  - Додавання товару
  - Оновлення кількості
  - Видалення товару
- ✅ Order API
  - Створення замовлення
  - Отримання замовлень користувача
  - Отримання деталей замовлення

## REST API Ендпоінти

### Клієнти (Customer)

- `POST /api/customers/register` - Реєстрація нового клієнта
- `POST /api/customers/login` - Авторизація клієнта
- `GET /api/customers/me` - Отримання профілю авторизованого клієнта
- `PUT /api/customers/me` - Оновлення профілю авторизованого клієнта

### Каталог (Catalog)

- `GET /api/categories` - Отримання списку категорій
- `GET /api/categories/{id}` - Отримання даних про окрему категорію
- `GET /api/products` - Отримання списку продуктів
- `GET /api/products/{id}` - Отримання даних про окремий продукт
- `GET /api/product-filters` - Отримання доступних фільтрів для продуктів

### Кошик (Cart)

- `GET /api/cart` - Отримання поточного кошика
- `POST /api/cart/items` - Додавання товару до кошика
- `PUT /api/cart/items/{id}` - Оновлення кількості товару в кошику
- `DELETE /api/cart/items/{id}` - Видалення товару з кошика

### Замовлення (Order)

- `GET /api/orders` - Отримання списку замовлень авторизованого клієнта
- `GET /api/orders/{id}` - Отримання даних про окреме замовлення
- `POST /api/orders` - Створення нового замовлення на основі кошика

## Відомі проблеми та обмеження

1. **Міграції**: Деякі тести можуть завершитися невдачею, якщо у вас є непрацюючі або конфліктуючі міграції. Перед запуском тестів переконайтеся, що міграції в порядку:

```bash
docker compose exec php php artisan migrate:status
```

Якщо виникають конфлікти міграцій, спробуйте наступні кроки:
```bash
# Відкат всіх міграцій
docker compose exec php php artisan migrate:reset

# Прогін всіх міграцій з початку
docker compose exec php php artisan migrate

# Якщо потрібно, заповніть базу тестовими даними
docker compose exec php php artisan db:seed
```

2. **Фабрики**: У проекті реалізовані фабрики для всіх основних моделей:
   - `CatalogCategoryFactory`
   - `CatalogProductFactory`
   - `CustomerEntityFactory`
   - `QuoteFactory`
   - `QuoteItemFactory`
   - `SalesOrderFactory`
   - `SalesOrderItemFactory`

3. **Тестова база даних**: Тести можуть використовувати як SQLite в пам'яті, так і PostgreSQL. 
   - SQLite: швидко, але може не підтримувати всі PostgreSQL функції:
```xml
<php>
    <env name="APP_ENV" value="testing"/>
    <env name="DB_CONNECTION" value="sqlite"/>
    <env name="DB_DATABASE" value=":memory:"/>
</php>
```

2. **Тестовий PostgreSQL** - повна сумісність, але потребує додаткової конфігурації:
```xml
<php>
    <env name="APP_ENV" value="testing"/>
    <env name="DB_CONNECTION" value="pgsql"/>
    <env name="DB_DATABASE" value="nutsshop_test"/>
</php>
```

## Подальші поліпшення

- [ ] Розширити покриття тестами до >= 80%
- [ ] Додати тести для адмін-панелі
- [ ] Додати тести для обробки платежів
- [ ] Впровадити інтеграційне тестування з реальними платіжними системами
- [ ] Впровадити автоматичне тестування при кожному commit через CI/CD

# Тестування API NutsShop

Цей документ описує інструменти та підходи до тестування API нашого інтернет-магазину NutsShop.

## Поточний стан тестування

У проекті реалізовано систему тестування з використанням PHPUnit. Створено набір тестів для API, який покриває основні функції:

- Авторизація та робота з клієнтами (CustomerTest)
- Робота з кошиком (CartTest)
- Робота з каталогом (CatalogCategoryTest, CatalogProductTest)
- Робота з замовленнями (OrderTest)

### Налаштовані тести

1. **CustomerTest**:
   - Реєстрація нового клієнта
   - Авторизація клієнта
   - Отримання профілю клієнта
   - Оновлення профілю
   - Перевірка відмови в доступі без авторизації

2. **CartTest**:
   - Перегляд порожнього кошика
   - Додавання товару в кошик
   - Зміна кількості товару в кошику
   - Видалення товару з кошика
   - Робота з кошиком як авторизований клієнт

3. **CatalogCategoryTest**:
   - Отримання списку категорій
   - Отримання окремої категорії
   - Перевірка на неіснуючу категорію
   - Тестування ієрархії категорій

4. **CatalogProductTest**:
   - Отримання списку товарів
   - Отримання окремого товару
   - Перевірка на неіснуючий товар
   - Фільтрація товарів за категорією
   - Фільтрація товарів за ціною

5. **OrderTest**:
   - Створення замовлення з кошика
   - Перегляд замовлення авторизованим клієнтом
   - Перевірка доступу до замовлень інших клієнтів

## Налаштування тестового середовища

Для тестування можна використовувати:

1. **SQLite в пам'яті** - швидко, але може не підтримувати всі PostgreSQL функції:
```xml
<php>
    <env name="APP_ENV" value="testing"/>
    <env name="DB_CONNECTION" value="sqlite"/>
    <env name="DB_DATABASE" value=":memory:"/>
</php>
```

2. **Тестовий PostgreSQL** - повна сумісність, але потребує додаткової конфігурації:
```xml
<php>
    <env name="APP_ENV" value="testing"/>
    <env name="DB_CONNECTION" value="pgsql"/>
    <env name="DB_DATABASE" value="nutsshop_test"/>
</php>
```

## Виконання тестів

### Запуск всіх API тестів

```bash
docker compose exec php php artisan test
```

### Запуск конкретного тесту

```bash
docker compose exec php php artisan test --filter=CustomerTest
```

## Postman колекція

Для ручного тестування API, використовуйте Postman колекцію, розташовану в кореневому каталозі проекту:

```
/postman_collection.json
```

### Налаштування колекції:

1. Імпортуйте колекцію в Postman
2. Створіть середовище з наступними змінними:
   - `base_url`: `http://localhost:8090/api` (для локального середовища)
   - `auth_token`: буде автоматично встановлено після успішного входу

### Особливості використання колекції:

- Запити організовані в логічні групи: Аутентифікація, Каталог, Кошик, Замовлення, Адмін
- Запит "Login" містить скрипт, який автоматично зберігає токен аутентифікації
- Для тестування потоку замовлення використовуйте запити в наступному порядку:
  1. Register/Login
  2. Add item(s) to cart
  3. Create order
  4. View orders

## Тестування безпеки

Тести перевіряють наступні аспекти безпеки:

1. Автентифікація через API токени
2. Авторизація (перевірка доступу до ресурсів)
3. Валідація вхідних даних
4. Захист від міжсайтової підробки запитів (CSRF)

## Рекомендації для розробників

1. **Написання нових тестів**:
   - Дотримуйтесь структури існуючих тестів
   - Використовуйте фабрики для створення тестових даних
   - Переконайтеся, що кожен тест ізольований

2. **Тестування контролерів**:
   - Перевіряйте статус відповіді
   - Перевіряйте структуру відповіді
   - Перевіряйте зміни в базі даних

3. **Тестування middleware**:
   - Перевіряйте доступ до захищених ресурсів
   - Перевіряйте поведінку при відсутності аутентифікації
   - Перевіряйте обробку неправильних токенів

## Відомі проблеми

1. При використанні SQLite в пам'яті деякі специфічні для PostgreSQL функції можуть не працювати, і тести можуть потребувати модифікації для врахування відмінностей діалектів SQL.

2. При запуску тестів на CI-сервері, переконайтеся, що змінні середовища правильно налаштовані. 

3. Тести для logout просто імітують виконання цієї функції, оскільки API-ендпоінт для logout не реалізований в контролері. 

# API Testing Framework

Цей каталог містить тести для API NutsShop. Більшість тестів використовують Laravel's HTTP testing utilities для перевірки API endpoints.

## Запуск тестів

Щоб запустити всі тести API:

```bash
php artisan test --testsuite=Feature
```

Щоб запустити конкретний тест:

```bash
php artisan test tests/Feature/Api/CustomerTest.php
```

## Структура тестів

Тести організовані навколо основних компонентів API:

1. `CustomerTest.php` - тести API аутентифікації та керування профілем клієнтів
2. `CartTest.php` - тести API корзини покупок
3. `CatalogProductTest.php` - тести API для товарів каталогу
4. `CatalogCategoryTest.php` - тести API для категорій каталогу
5. `OrderTest.php` - тести API замовлень

## Фабрики моделей

Для тестування були створені фабрики для наступних моделей:

1. `CatalogCategoryFactory` - створення тестових категорій
2. `CatalogProductFactory` - створення тестових продуктів
3. `CustomerEntityFactory` - створення тестових клієнтів
4. `QuoteFactory` - створення тестових кошиків (корзин)
5. `QuoteItemFactory` - створення тестових елементів кошика
6. `SalesOrderFactory` - створення тестових замовлень
7. `SalesOrderItemFactory` - створення тестових елементів замовлення

## Виправлення тестів

Тести були адаптовані до існуючої структури API та бази даних:

1. **Структура відповідей API**
   - Оновлено очікувану структуру JSON в усіх тестах
   - Виправлено шляхи API для всіх ендпоінтів

2. **База даних**
   - Видалено залежність від неіснуючого поля `items_qty` в таблиці `quote`
   - Видалено тест фільтрації за категорією, що очікував неіснуюче поле `category_id` в таблиці `catalog_product`

3. **Аутентифікація**
   - Оновлено механізм аутентифікації в тестах
   - Виправлено тест для виходу користувача

4. **Іменування методів**
   - Оновлено назви методів тестування відповідно до стандартів camelCase

## Відомі обмеження

1. **Міграції**
   - Деякі тести можуть не працювати через розбіжності між схемою бази даних та моделями
   - Потрібно переконатися, що в таблиці `quote` є необхідні поля: `items_count` та `grand_total`
   - Потрібно переконатися, що в таблиці `quote_item` є необхідні поля: `unit_price` та `row_total`

2. **API ендпоінти для адміністративної частини**
   - Тести охоплюють лише клієнтську частину API
   - Для повного тестування необхідно додати тести для адміністративної частини 